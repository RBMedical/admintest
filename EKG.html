<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test - Admin</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="" name="keywords">
  <meta content="" name="description">

  <link href="img/favicon.ico" rel="icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
  <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<style>
  html,
  body {
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: "Kanit", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  .container-fluid.position-relative.bg-white.d-flex.p-0 {
    height: 100vh;
    overflow: hidden;
  }

  .sidebar {
    height: 100vh;
    overflow: auto;
  }

  .content {
    height: 100vh;
    overflow: hidden;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }

  .nav-link svg {
    margin-right: 8px;
    display: inline-block;
  }

  .logout-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 10px;
    text-decoration: none;
    color: #0f2b38;
    border: 1px solid rgba(0, 0, 0, 0.08);
    background: #fff;
    transition: .15s ease;
    font-weight: 600;
    white-space: nowrap;
  }

  .logout-link:hover {
    background: #f3fbff;
    transform: translateY(-1px);
  }

  .table-wrapper {
    max-height: calc(100vh - 360px);
    overflow-y: auto;
    overflow-x: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
  }

  .table-wrapper table {
    margin-bottom: 0;
  }

  .table-wrapper thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: lightblue;
  }

  /* ✅ แสดงสรุปจำนวนบนหัวตารางมุมขวา */
  .table-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }

  .spec-counts {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: flex-end;
    text-align: right;
    font-size: 14px;
    font-weight: 600;
  }

  .spec-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(0, 0, 0, 0.10);
    background: #fff;
    white-space: nowrap;
  }

  .spec-pill .badge {
    font-size: 12px;
  }

  .spec-pill .badge{
  font-size: 14px;           /* เดิมเล็กไป -> เพิ่ม */
  padding: 6px 10px;         /* ให้ดูเป็นเม็ดยา */
  border-radius: 999px;
  background: #eaf7ff !important;  /* โทนสีอ่อน */
  color: #0f2b38 !important;       /* โทนสีเข้ม */
  border: 1px solid rgba(15,43,56,.15);
  font-weight: 700;
  line-height: 1;
}
</style>

<body>
  <div class="container-fluid position-relative bg-white d-flex p-0">

    <div id="spinner"
      class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <!-- Sidebar Start -->
    <div class="sidebar pe-4 pb-3">
      <nav class="navbar bg-light navbar-light">
        <a href="index.html" class="navbar-brand mx-4 mb-3">
          <h3 class="text-primary">Check Up</h3>
        </a>

        <div class="d-flex align-items-center ms-4 mb-4">
          <div class="position-relative">
            <img class="rounded-circle" src="" alt="" style="width: 40px; height: 40px;" />
            <div class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1">
            </div>
          </div>
          <div class="ms-3">
            <h6 class="mb-0">Name</h6>
            <span>Admin</span>
          </div>
        </div>

        <div class="navbar-nav w-100">
          <a href="index.html" class="nav-item nav-link mt-5">X Ray</a>
          <a href="EKG.html" class="nav-item nav-link active mt-3">EKG</a>
          <a href="PE.html" class="nav-item nav-link mt-3">ซักประวัติ</a>
          <a href="Bloodtest.html" class="nav-item nav-link mt-3">เจาะเลือด</a>
          <a href="UA.html" class="nav-item nav-link mt-3">ส่งปัสสาวะ</a>
        </div>
      </nav>
    </div>
    <!-- Sidebar End -->

    <div class="content">
      <!-- Navbar Start -->
      <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
        <a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
          <h2 class="text-primary mb-0"><i class="fa fa-hashtag"></i></h2>
        </a>

        <a href="#" class="sidebar-toggler flex-shrink-0">
          <i class="fa fa-bars"></i>
        </a>

        <div class="ms-auto d-flex align-items-center">
          <a href="#" class="logout-link">
            <i class="fa fa-sign-out-alt"></i>
            Log Out
          </a>
        </div>
      </nav>

      <div class="container-fluid mt-5" style="flex:1; overflow:hidden; display:flex; flex-direction:column;">
        <div class="row align-items-start w-100">
          <div class="col-10">
            <form class="row g-2">
              <div class="col-6 ms-4">
                <div class="input-group">
                  <input type="text" class="form-control" id="searchid" placeholder="Barcode Here">
                </div>
              </div>

              <div class="col-auto">
                <button type="button" id="submit" onclick="submitSearch(event)" class="btn btn-primary">Search</button>
              </div>
            </form>
          </div>

          <div class="col-2 text-end">
            <button type="button" class="btn btn-primary" onclick="pickExcelOnce()">+</button>
          </div>
        </div>

        <div class="container-fluid pt-4 px-4" style="flex:1; overflow:hidden;">
          <div class="bg-light rounded h-100 p-4" style="height:100%; overflow:hidden; display:flex; flex-direction:column;">

            <!-- ✅ หัวตาราง: ซ้ายชื่อ / ขวาสรุปจำนวน -->
            <div class="table-header-row">
              <h6 class="mb-0">Bordered Table</h6>
              <div id="specCounts" class="spec-counts"></div>
            </div>

            <div class="table-wrapper">
              <table id="specimenlist" class="table table-bordered" style="font-family: kanit;">
                <colgroup>
                  <col style="width: 5%;">
                  <col style="width: 20%;">
                  <col style="width: 55%;">
                  <col style="width: 15%;">
                  <col style="width: 5%;">
                </colgroup>
                <thead class="text-center" style="background-color:lightblue;">
                  <tr>
                    <th scope="col">No</th>
                    <th scope="col">ID</th>
                    <th scope="col">ชื่อ นามสกุล</th>
                    <th scope="col">specimen</th>
                    <th scope="col">ลบ</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- JS เติม -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="showmodal" style="display: none;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Chest X-Ray</h5>
            <button type="button" class="btn-close" aria-label="Close" onclick="closemodal()"></button>
          </div>

          <div class="modal-body">
            <div class="row g-3">
              <div class="col-sm-4">
                <span class="form-control" id="showid"></span>
              </div>
              <div class="col-sm-8">
                <span class="form-control" id="showname"></span>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closemodal()">Close</button>
            <button id="addspecimen" type="button" onclick="addSpecimen(event)" class="btn btn-primary">Input</button>
          </div>
        </div>
      </div>
    </div>
    <!-- /modal -->

  </div>

  <script>
    let fileHandle = null;
    let workbook = null;
    let cachedData = [];

    // ✅ เดิมของคุณเป็น EKG แต่คำขอใหม่คือ "นับจำนวนคอลัมน์ที่ 4"
    // ดังนั้น: คอลัมน์ที่ 4 ในตาราง = specimen (ใน aoa คือ index 3)
    // เราจะนับจาก "ตารางที่แสดงอยู่" (DOM) ไม่ใช่ใน Specimen Sheet โดยตรง

    function normalizeId(v) {
      return String(v ?? "").trim().replace(/\s+/g, "").replace(/-/g, "").toUpperCase();
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[m]));
    }

    // ================= SWEET ALERT HELPERS =================
    function showLoading(title = "กำลังดำเนินการ...") {
      Swal.fire({
        title,
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });
    }

    function showSuccess(title, text) {
      Swal.fire({
        icon: 'success',
        title,
        html: `<b>${text}</b>`,
        timer: 2000,
        timerProgressBar: true,
        showConfirmButton: false
      });
    }

    function showError(text) {
      Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด',
        text
      });
    }

    function showWarning(text) {
      Swal.fire({
        icon: 'warning',
        title: 'แจ้งเตือน',
        text
      });
    }
    // ======================================================

    function openmodal() {
      document.getElementById("showmodal").style.display = "block";
    }

    function closemodal() {
      document.getElementById("showmodal").style.display = "none";
    }

    // ====== PICK EXCEL ======
    async function pickExcelOnce() {
      try {
        if (!window.showOpenFilePicker) {
          return showError("ต้องใช้ Chrome/Edge ผ่าน https หรือ localhost");
        }

        [fileHandle] = await window.showOpenFilePicker({
          multiple: false,
          types: [{
            description: "Excel",
            accept: {
              "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": [".xlsx"],
              "application/vnd.ms-excel": [".xls"]
            }
          }]
        });

        showLoading("กำลังโหลดไฟล์...");

        const file = await fileHandle.getFile();
        const buffer = await file.arrayBuffer();
        workbook = XLSX.read(buffer, { type: "array" });

        loadDataSheet();
        showSpecimen(); // เติมตาราง
        Swal.close();
        showSuccess("โหลดสำเร็จ", `อัพโหลดรายชื่อสำเร็จ จำนวน ${cachedData.length} ราย`);

      } catch (err) {
        Swal.close();
        showError(err.message || "ไม่สามารถเปิดไฟล์ได้");
      }
    }

    // ====== LOAD DATA SHEET ======
    function loadDataSheet() {
      if (!workbook) return;

      const dataName = workbook.SheetNames.find(n => n.trim().toLowerCase() === "data");
      if (!dataName) {
        cachedData = [];
        return showError('ไม่พบชีตชื่อ "Data"');
      }

      const ws = workbook.Sheets[dataName];
      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
      const body = aoa.slice(1);

      cachedData = body
        .filter(r => normalizeId(r?.[0]) !== "")
        .map(r => {
          const idRaw = r?.[0];
          const c = String(r?.[2] ?? "").trim();
          const d = String(r?.[3] ?? "").trim();
          const e = String(r?.[4] ?? "").trim();
          return {
            id: String(idRaw ?? "").trim(),
            idNorm: normalizeId(idRaw),
            name: [c, d, e].filter(Boolean).join(" ")
          };
        });
    }

    // ====== SEARCH ======
    function submitSearch(e) {
      if (e) e.preventDefault();

      if (!cachedData.length) return showWarning("กรุณาเลือกไฟล์ก่อน");

      const key = normalizeId(document.getElementById("searchid")?.value);
      if (!key) return showWarning("กรุณากรอก ID");

      const found = cachedData.find(x => x.idNorm === key);

      if (found) {
        document.getElementById("showid").textContent = found.id;
        document.getElementById("showname").textContent = found.name;
        openmodal();
      } else {
        showError("ไม่พบ ID นี้");
      }
    }

    // ====== ADD SPECIMEN (ตัวอย่างเดิม: เพิ่มลง Specimen sheet) ======
    // หมายเหตุ: คุณยังสามารถปรับให้เลือก EDTA/Naf/Clot ได้ตามหน้าอื่น
    async function addSpecimen(e) {
      if (e) e.preventDefault();

      try {
        if (!fileHandle || !workbook) return showWarning("ยังไม่ได้เลือกไฟล์");

        const id = (document.getElementById("showid")?.textContent || "").trim();
        const name = (document.getElementById("showname")?.textContent || "").trim();

        if (!id || !name) return showWarning("ต้องค้นหา ID ให้พบก่อน");

        const specName = workbook.SheetNames.find(n => n.trim().toLowerCase() === "specimen");
        if (!specName) return showError('ไม่พบชีตชื่อ "Specimen"');

        showLoading("กำลังบันทึกข้อมูล...");

        const ws = workbook.Sheets[specName];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

        let last = aoa.length - 1;
        while (last >= 0 && (aoa[last] || []).every(v => String(v).trim() === "")) last--;
        const nextRow = last + 1;

        // ตัวอย่าง: ใส่ค่า specimen เป็น EDTA (คุณเปลี่ยนได้)
        const row = aoa[nextRow] ? [...aoa[nextRow]] : [];
        row[0] = id;
        row[1] = name;
        row[2] = "เจาะเลือด";
        row[3] = "EDTA"; // ✅ ช่องที่ 4 (index 3)
        aoa[nextRow] = row;

        workbook.Sheets[specName] = XLSX.utils.aoa_to_sheet(aoa);

        const perm = await fileHandle.requestPermission({ mode: "readwrite" });
        if (perm !== "granted") {
          Swal.close();
          return showError("ไม่ได้รับอนุญาตให้เขียนไฟล์");
        }

        const writable = await fileHandle.createWritable();
        const out = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
        await writable.write(out);
        await writable.close();

        Swal.close();
        showSuccess("บันทึกสำเร็จ", "ข้อมูลถูกเพิ่มใน Specimen แล้ว");

        showSpecimen();
        closemodal();

      } catch (err) {
        Swal.close();
        showError(err.message || "บันทึกไม่สำเร็จ");
      }
    }

    // ====== DELETE ROW (ลบจริงใน Specimen sheet) ======
    async function deleteSpecimenRow(sheetRowIndex) {
      try {
        if (!fileHandle || !workbook) return showWarning("ยังไม่ได้เลือกไฟล์");

        const confirm = await Swal.fire({
          icon: "warning",
          title: "ยืนยันการลบ?",
          text: "รายการนี้จะถูกลบออกจากไฟล์ Excel ทันที",
          showCancelButton: true,
          confirmButtonText: "ลบ",
          cancelButtonText: "ยกเลิก"
        });

        if (!confirm.isConfirmed) return;

        const specName = workbook.SheetNames.find(n => n.trim().toLowerCase() === "specimen");
        if (!specName) return showError('ไม่พบชีตชื่อ "Specimen"');

        showLoading("กำลังลบข้อมูล...");

        const ws = workbook.Sheets[specName];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

        aoa.splice(sheetRowIndex, 1);

        workbook.Sheets[specName] = XLSX.utils.aoa_to_sheet(aoa);

        const perm = await fileHandle.requestPermission({ mode: "readwrite" });
        if (perm !== "granted") {
          Swal.close();
          return showError("ไม่ได้รับอนุญาตให้เขียนไฟล์");
        }

        const writable = await fileHandle.createWritable();
        const out = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
        await writable.write(out);
        await writable.close();

        Swal.close();
        showSuccess("ลบสำเร็จ", "ลบรายการเรียบร้อยแล้ว");
        showSpecimen();

      } catch (err) {
        Swal.close();
        showError(err.message || "ลบไม่สำเร็จ");
      }
    }

    // ====== ✅ สรุปจำนวนจาก "ตารางที่แสดง" (ช่องที่ 4) แล้วแสดงมุมขวาหัวตาราง ======
    function renderCountsFromTable() {
      const box = document.getElementById("specCounts");
      if (!box) return;

      const rows = document.querySelectorAll("#specimenlist tbody tr");
      const counts = {};

      rows.forEach(tr => {
        // ช่องที่ 4 = td ลำดับที่ 3 (0:ID,1:Name,2:specimen?? => ในตารางของเรา: [No,ID,Name,specimen,delete])
        // ดังนั้น specimen อยู่ cell index 3 ของทั้งแถว (th/td รวมกัน)
        const cells = tr.querySelectorAll("th,td");
        const sp = (cells[3]?.textContent || "").trim();
        if (!sp) return;
        counts[sp] = (counts[sp] || 0) + 1;
      });

      const keys = Object.keys(counts).sort((a, b) => a.localeCompare(b));
      if (keys.length === 0) {
        box.innerHTML = "";
        return;
      }

      box.innerHTML = keys.map(k => {
        const n = counts[k];
        return `
          <span class="spec-pill">
            ${escapeHtml(k)}
            <span class="badge bg-primary">${n}</span>
          </span>
        `;
      }).join("");
    }

    // ====== SHOW SPECIMEN + ปุ่มลบ ======
    function showSpecimen() {
  if (!workbook) return;

  const specName = workbook.SheetNames.find(n => n.trim().toLowerCase() === "specimen");
  if (!specName) return;

  const ws = workbook.Sheets[specName];
  const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

  const tbody = document.querySelector("#specimenlist tbody");
  if (!tbody) return;

  tbody.innerHTML = "";
  let no = 1;

  const targetC = "ตรวจคลื่นไฟฟ้าหัวใจ";

  // i=1 เพราะ i=0 คือหัวตารางใน Excel
  for (let i = 1; i < aoa.length; i++) {
    const r = aoa[i] || [];
    const colA = String(r[0] ?? "").trim(); // ID
    const colB = String(r[1] ?? "").trim(); // Name
    const colC = String(r[2] ?? "").trim(); // ✅ C
    const colD = String(r[3] ?? "").trim(); // specimen/code

    if (!colA && !colB && !colC && !colD) continue;
    if (colC !== targetC) continue; // ✅ แสดงเฉพาะ C ตรงนี้

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <th class="text-center">${no}</th>
      <td class="text-center">${escapeHtml(colA)}</td>
      <td>${escapeHtml(colB)}</td>
      <td class="text-center">${escapeHtml(colD)}</td>
      <td class="text-center">
        <button type="button" class="btn btn-sm btn-danger" data-row="${i}">
          <i class="fa fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
    no++;
  }

  // bind ปุ่มลบ
  tbody.querySelectorAll('button[data-row]').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.getAttribute('data-row'), 10);
      deleteSpecimenRow(idx);
    });
  });

  // ถ้าคุณยังใช้ตัวนับบนหัวตาราง (นับจากตารางที่แสดง)
  if (typeof renderCountsFromTable === "function") {
    renderCountsFromTable();
  }
}
  </script>

  <!-- JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="lib/chart/chart.min.js"></script>
  <script src="lib/easing/easing.min.js"></script>
  <script src="lib/waypoints/waypoints.min.js"></script>
  <script src="lib/owlcarousel/owl.carousel.min.js"></script>
  <script src="lib/tempusdominus/js/moment.min.js"></script>
  <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
  <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

  <!-- Template Javascript -->
  <script src="js/main.js"></script>
</body>

</html>