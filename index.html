<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test - Admin</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="" name="keywords">
  <meta content="" name="description">

  <link href="img/favicon.ico" rel="icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
  <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<style>
  html,
  body {
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: "Kanit", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  .container-fluid.position-relative.bg-white.d-flex.p-0 {
    height: 100vh;
    overflow: hidden;
  }

  .sidebar {
    height: 100vh;
    overflow: auto;
  }

  .content {
    height: 100vh;
    overflow: hidden;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }

  .nav-link svg {
    margin-right: 8px;
    display: inline-block;
  }

  /* ✅ Log Out link */
  .logout-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    border-radius: 10px;
    text-decoration: none;
    color: #0f2b38;
    border: 1px solid rgba(0, 0, 0, 0.08);
    background: #fff;
    transition: .15s ease;
    font-weight: 600;
    white-space: nowrap;
  }

  .logout-link:hover {
    background: #f3fbff;
    transform: translateY(-1px);
  }

  /* ✅ Table wrapper */
  .table-wrapper {
    max-height: calc(100vh - 360px);
    overflow-y: auto;
    overflow-x: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
  }

  .table-wrapper table {
    margin-bottom: 0;
  }

  .table-wrapper thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: lightblue;
  }

  /* ✅ สรุปจำนวน */
  .spec-counts {
    display: flex;
    flex-wrap: nowrap;
    white-space: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    gap: 8px;
    justify-content: flex-end;
    margin-bottom: 12px;
  }

  .spec-counts::-webkit-scrollbar {
    height: 6px;
  }

  .spec-counts::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, .15);
    border-radius: 99px;
  }

  .spec-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(0, 0, 0, .10);
    background: #fff;
    white-space: nowrap;
    font-weight: 700;
    font-size: 14px;
  }

  .spec-pill .badge {
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 999px;
    background: #eaf7ff !important;
    color: #0f2b38 !important;
    border: 1px solid rgba(15, 43, 56, .15);
    font-weight: 800;
    line-height: 1;
  }

  /* ✅ ปุ่มลบ */
  .btn-delete {
    width: 34px;
    height: 34px;
    padding: 0;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* Tablet แนวนอน 8-10 นิ้ว */
  @media (min-width: 900px) and (max-width: 1280px) {
    table {
      font-size: 14px;
    }

    th,
    td {
      padding: 6px;
    }

    input,
    textarea,
    select {
      font-size: 16px;
      padding: 6px;
    }

    button {
      font-size: 16px;
      padding: 10px 18px;
    }

    .table-wrapper {
      max-height: calc(100vh - 330px);
    }
  }

  @media (max-width: 576px) {
    .content {
      padding: 12px;
    }

    .table-wrapper {
      max-height: calc(100vh - 320px);
    }
  }
</style>

<body>
  <div class="container-fluid position-relative bg-white d-flex p-0">
    <div id="spinner"
      class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <!-- Sidebar Start -->
    <div class="sidebar pe-4 pb-3">
      <nav class="navbar bg-light navbar-light">
        <a href="index.html" class="navbar-brand mx-4 mb-3">
          <h3 class="text-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
              class="bi bi-hospital-fill" viewBox="0 0 16 16">
              <path
                d="M6 0a1 1 0 0 0-1 1v1a1 1 0 0 0-1 1v4H1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h6v-2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5V16h6a1 1 0 0 0 1-1V8a1 1 0 0 0-1-1h-3V3a1 1 0 0 0-1-1V1a1 1 0 0 0-1-1z" />
            </svg>
            Check Up
          </h3>
        </a>

        <div class="d-flex align-items-center ms-4 mb-4">
          <div class="position-relative">
            <img class="rounded-circle" src="" alt="" style="width: 40px; height: 40px;" />
            <div class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1">
            </div>
          </div>
          <div class="ms-3">
            <h6 class="mb-0">Name</h6>
            <span>Admin</span>
          </div>
        </div>

        <div class="navbar-nav w-100">
          <a href="index.html" class="nav-item nav-link active mt-5">X Ray</a>
          <a href="table.html" class="nav-item nav-link mt-3">EKG</a>
          <a href="chart.html" class="nav-item nav-link mt-3">ซักประวัติ</a>
          <a href="form.html" class="nav-item nav-link mt-3">เจาะเลือด</a>
          <a href="button.html" class="nav-item nav-link mt-3">ส่งปัสสาวะ</a>
        </div>
      </nav>
    </div>
    <!-- Sidebar End -->

    <div class="content">
      <nav class="navbar navbar-expand bg-light navbar-light sticky-top px-4 py-0">
        <a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
          <h2 class="text-primary mb-0"><i class="fa fa-hashtag"></i></h2>
        </a>

        <a href="#" class="sidebar-toggler flex-shrink-0">
          <i class="fa fa-bars"></i>
        </a>

        <div class="ms-auto d-flex align-items-center">
          <a href="#" class="logout-link">
            <i class="fa fa-sign-out-alt"></i>
            Log Out
          </a>
        </div>
      </nav>

      <div class="container-fluid mt-5" style="flex:1; overflow:hidden; display:flex; flex-direction:column;">
        <div class="row align-items-start w-100">
          <div class="col-10">
            <form class="row g-2">
              <div class="col-6 ms-4">
                <div class="input-group">
                  <input type="text" class="form-control" id="searchid" placeholder="Barcode Here">
                </div>
              </div>

              <div class="col-auto">
                <button type="button" id="submit" onclick="submitSearch(event)" class="btn btn-primary">Search</button>
              </div>
            </form>
          </div>

          <div class="col-2 text-end">
            <button type="button" class="btn btn-primary" onclick="pickExcelOnce()">+</button>
          </div>
        </div>

        <div class="container-fluid pt-4 px-4" style="flex:1; overflow:hidden;">
          <div class="bg-light rounded h-100 p-4" style="height:100%; overflow:hidden; display:flex; flex-direction:column;">

            <!-- ✅ สรุปจำนวน (หัวข้อไว้ล่วงหน้า: X-Ray) -->
            <div class="spec-counts" id="specCounts"></div>

            <div class="table-wrapper">
              <table id="specimenlist" class="table table-bordered" style="font-family: kanit;">
                <colgroup>
                  <col style="width: 5%;">
                  <col style="width: 20%;">
                  <col style="width: 55%;">
                  <col style="width: 15%;">
                  <col style="width: 5%;">
                </colgroup>
                <thead class="text-center" style="background-color:lightblue;">
                  <tr>
                    <th scope="col">No</th>
                    <th scope="col">ID</th>
                    <th scope="col">ชื่อ นามสกุล</th>
                    <th scope="col">specimen</th>
                    <th scope="col">ลบ</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- JS เติม -->
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="showmodal" style="display:none;">
    <div class="modal-dialog">
      <div class="modal-content" style="background-color: lightsteelblue;">
        <div class="modal-header">
          <h5 class="modal-title">X Ray</h5>
          <button type="button" class="btn-close" aria-label="Close" onclick="closemodal()"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-sm-4">
              <span class="form-control" id="showid"></span>
            </div>
            <div class="col-sm-8">
              <span class="form-control" id="showname"></span>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closemodal()">Close</button>
          <button id="addspecimen" type="button" onclick="addSpecimen(event)" class="btn btn-primary">Input</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let fileHandle = null;
    let workbook = null;
    let cachedData = [];

    // ✅ หัวข้อไว้ล่วงหน้า: X-Ray (ตามที่ขอ)
    const SPECIMEN_HEADERS = ["X-Ray"];

    function normalizeId(v) {
      return String(v ?? "").trim().replace(/\s+/g, "").replace(/-/g, "").toUpperCase();
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[m]));
    }

    function showLoading(title = "กำลังดำเนินการ...") {
      Swal.fire({ title, allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    }
    function showSuccess(title, text) {
      Swal.fire({ icon: 'success', title, html: `<b>${text}</b>`, timer: 2000, timerProgressBar: true, showConfirmButton: false });
    }
    function showError(text) {
      Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text });
    }
    function showWarning(text) {
      Swal.fire({ icon: 'warning', title: 'แจ้งเตือน', text });
    }

    function openmodal() { document.getElementById("showmodal").style.display = "block"; }
    function closemodal() { document.getElementById("showmodal").style.display = "none"; }

    // ====== PICK EXCEL ======
    async function pickExcelOnce() {
      try {
        if (!window.showOpenFilePicker) {
          return showError("ต้องใช้ Chrome/Edge ผ่าน https หรือ localhost");
        }

        [fileHandle] = await window.showOpenFilePicker({
          multiple: false,
          types: [{
            description: "Excel",
            accept: {
              "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": [".xlsx"],
              "application/vnd.ms-excel": [".xls"]
            }
          }]
        });

        showLoading("กำลังโหลดไฟล์...");

        const file = await fileHandle.getFile();
        const buffer = await file.arrayBuffer();
        workbook = XLSX.read(buffer, { type: "array" });

        loadDataSheet();
        showSpecimen();

        Swal.close();
        showSuccess("โหลดสำเร็จ", `อัพโหลดรายชื่อสำเร็จ จำนวน ${cachedData.length} ราย `);

      } catch (err) {
        Swal.close();
        showError(err.message || "ไม่สามารถเปิดไฟล์ได้");
      }
    }

    // ====== LOAD DATA SHEET ======
    function loadDataSheet() {
      if (!workbook) return;

      const dataName = workbook.SheetNames.find(n => n.trim().toLowerCase() === "data");
      if (!dataName) {
        cachedData = [];
        return showError('ไม่พบชีตชื่อ "Data"');
      }

      const ws = workbook.Sheets[dataName];
      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
      const body = aoa.slice(1);

      cachedData = body
        .filter(r => normalizeId(r?.[0]) !== "")
        .map(r => {
          const idRaw = r?.[0];
          const c = String(r?.[2] ?? "").trim();
          const d = String(r?.[3] ?? "").trim();
          const e = String(r?.[4] ?? "").trim();
          return {
            id: String(idRaw ?? "").trim(),
            idNorm: normalizeId(idRaw),
            name: [c, d, e].filter(Boolean).join(" ")
          };
        });
    }

    // ====== SEARCH ======
    function submitSearch(e) {
      if (e) e.preventDefault();

      if (!cachedData.length) return showWarning("กรุณาเลือกไฟล์ก่อน");

      const key = normalizeId(document.getElementById("searchid")?.value);
      if (!key) return showWarning("กรุณากรอก ID");

      const found = cachedData.find(x => x.idNorm === key);
      if (!found) return showError("ไม่พบ ID นี้");

      document.getElementById("showid").textContent = found.id;
      document.getElementById("showname").textContent = found.name;
      openmodal();
    }

    // ====== ADD SPECIMEN ======
    async function addSpecimen(e) {
      if (e) e.preventDefault();

      try {
        if (!fileHandle || !workbook) return showWarning("ยังไม่ได้เลือกไฟล์");

        const id = (document.getElementById("showid")?.textContent || "").trim();
        const name = (document.getElementById("showname")?.textContent || "").trim();
        if (!id || !name) return showWarning("ต้องค้นหา ID ให้พบก่อน");

        const specName = workbook.SheetNames.find(n => n.trim().toLowerCase() === "specimen");
        if (!specName) return showError('ไม่พบชีตชื่อ "Specimen"');

        showLoading("กำลังบันทึกข้อมูล...");

        const ws = workbook.Sheets[specName];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

        let last = aoa.length - 1;
        while (last >= 0 && (aoa[last] || []).every(v => String(v).trim() === "")) last--;
        const nextRow = last + 1;

        const row = aoa[nextRow] ? [...aoa[nextRow]] : [];
        row[0] = id;         // A
        row[1] = name;       // B
        row[2] = "เอ็กซเรย์"; // ✅ C
        row[3] = "X-Ray";    // ✅ D (ตรงกับหัวข้อสรุป)
        aoa[nextRow] = row;

        workbook.Sheets[specName] = XLSX.utils.aoa_to_sheet(aoa);

        const perm = await fileHandle.requestPermission({ mode: "readwrite" });
        if (perm !== "granted") {
          Swal.close();
          return showError("ไม่ได้รับอนุญาตให้เขียนไฟล์");
        }

        const writable = await fileHandle.createWritable();
        const out = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
        await writable.write(out);
        await writable.close();

        Swal.close();
        showSuccess("บันทึกสำเร็จ", "ข้อมูลถูกเพิ่มใน Specimen แล้ว");

        showSpecimen();
        closemodal();

      } catch (err) {
        Swal.close();
        showError(err.message || "บันทึกไม่สำเร็จ");
      }
    }

    // ✅ สรุปจำนวนจากตารางที่แสดง (คอลัมน์ 4 = specimen)
    function renderCountsFromTable() {
      const box = document.getElementById("specCounts");
      if (!box) return;

      const rows = document.querySelectorAll("#specimenlist tbody tr");
      const counts = {};

      rows.forEach(tr => {
        const tds = tr.querySelectorAll("td");
        const sp = (tds[2]?.textContent || "").trim(); // td[2] = specimen
        if (!sp) return;
        counts[sp] = (counts[sp] || 0) + 1;
      });

      box.innerHTML = SPECIMEN_HEADERS.map(name => `
        <span class="spec-pill">
          ${escapeHtml(name)}
          <span class="badge">${counts[name] || 0}</span>
        </span>
      `).join("");
    }

    // ✅ ลบแถวใน Specimen sheet จริง (ตาม index แถว aoa)
    async function deleteSpecimenRow(sheetRowIndex) {
      try {
        if (!fileHandle || !workbook) return showWarning("ยังไม่ได้เลือกไฟล์");

        const confirm = await Swal.fire({
          icon: "warning",
          title: "ยืนยันการลบ?",
          text: "ต้องการลบรายการนี้ออกจากไฟล์ Excel ใช่หรือไม่",
          showCancelButton: true,
          confirmButtonText: "ลบ",
          cancelButtonText: "ยกเลิก"
        });
        if (!confirm.isConfirmed) return;

        const specName = workbook.SheetNames.find(n => n.trim().toLowerCase() === "specimen");
        if (!specName) return showError('ไม่พบชีตชื่อ "Specimen"');

        showLoading("กำลังลบข้อมูล...");

        const ws = workbook.Sheets[specName];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

        if (!Number.isInteger(sheetRowIndex) || sheetRowIndex <= 0 || sheetRowIndex >= aoa.length) {
          Swal.close();
          return showError("ไม่พบแถวที่ต้องการลบ");
        }

        aoa.splice(sheetRowIndex, 1); // ✅ ลบจริง

        workbook.Sheets[specName] = XLSX.utils.aoa_to_sheet(aoa);

        const perm = await fileHandle.requestPermission({ mode: "readwrite" });
        if (perm !== "granted") {
          Swal.close();
          return showError("ไม่ได้รับอนุญาตให้เขียนไฟล์");
        }

        const writable = await fileHandle.createWritable();
        const out = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
        await writable.write(out);
        await writable.close();

        Swal.close();
        showSuccess("ลบสำเร็จ", "ลบรายการออกจากไฟล์แล้ว");

        showSpecimen(); // รีเฟรชตาราง + จำนวน
      } catch (err) {
        Swal.close();
        showError(err.message || "ลบไม่สำเร็จ");
      }
    }

    // ====== SHOW SPECIMEN ======
    // ✅ ดึงเฉพาะแถวที่คอลัมน์ C = "เอ็กซเรย์"
    function showSpecimen() {
      if (!workbook) return;

      const specName = workbook.SheetNames.find(n => n.trim().toLowerCase() === "specimen");
      if (!specName) return;

      const ws = workbook.Sheets[specName];
      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

      const tbody = document.querySelector("#specimenlist tbody");
      if (!tbody) return;

      tbody.innerHTML = "";
      let no = 1;

      for (let i = 1; i < aoa.length; i++) {
        const r = aoa[i] || [];
        const colA = String(r[0] ?? "").trim(); // A ID
        const colB = String(r[1] ?? "").trim(); // B Name
        const colC = String(r[2] ?? "").trim(); // C
        const colD = String(r[3] ?? "").trim(); // D specimen

        if (!colA && !colB && !colC && !colD) continue;
        if (colC !== "เอ็กซเรย์") continue;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <th class="text-center">${no}</th>
          <td class="text-center">${escapeHtml(colA)}</td>
          <td>${escapeHtml(colB)}</td>
          <td class="text-center">${escapeHtml(colD)}</td>
          <td class="text-center">
            <button type="button" class="btn btn-danger btn-delete" title="ลบ" onclick="deleteSpecimenRow(${i})">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
        no++;
      }

      renderCountsFromTable();
    }
  </script>

  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="lib/chart/chart.min.js"></script>
  <script src="lib/easing/easing.min.js"></script>
  <script src="lib/waypoints/waypoints.min.js"></script>
  <script src="lib/owlcarousel/owl.carousel.min.js"></script>
  <script src="lib/tempusdominus/js/moment.min.js"></script>
  <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
  <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

  <script src="js/main.js"></script>
</body>

</html>
